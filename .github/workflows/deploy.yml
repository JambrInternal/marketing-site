name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      NEXT_PUBLIC_POSTHOG_KEY: ${{ secrets.NEXT_PUBLIC_POSTHOG_KEY || vars.NEXT_PUBLIC_POSTHOG_KEY }}
      NEXT_PUBLIC_POSTHOG_HOST: ${{ secrets.NEXT_PUBLIC_POSTHOG_HOST || vars.NEXT_PUBLIC_POSTHOG_HOST }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set base path
        run: |
          repo_name="${GITHUB_REPOSITORY##*/}"
          if [ -f public/CNAME ]; then
            echo "NEXT_PUBLIC_BASE_PATH=/" >> "$GITHUB_ENV"
          else
            echo "NEXT_PUBLIC_BASE_PATH=/$repo_name" >> "$GITHUB_ENV"
          fi

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Check PostHog env
        run: |
          if [ -n "${NEXT_PUBLIC_POSTHOG_KEY}" ]; then
            echo "PostHog key: set"
          else
            echo "PostHog key: missing"
          fi
          if [ -n "${NEXT_PUBLIC_POSTHOG_HOST}" ]; then
            echo "PostHog host: set"
          else
            echo "PostHog host: default"
          fi

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Mobile layout tests
        run: npm run test:e2e

      - name: Build static site
        run: npm run build

      - name: Prepare gh-pages branch
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          rm -rf .gh-pages
          if git ls-remote --exit-code --heads "https://github.com/${GITHUB_REPOSITORY}.git" gh-pages >/dev/null 2>&1; then
            git clone --branch gh-pages --single-branch \
              "https://x-access-token:${GH_TOKEN}@github.com/${GITHUB_REPOSITORY}.git" .gh-pages
          else
            mkdir .gh-pages
            pushd .gh-pages
            git init
            git checkout -b gh-pages
            git remote add origin "https://x-access-token:${GH_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"
            popd
          fi

      - name: Sync static export
        run: |
          if [ ! -d "out" ]; then
            echo "Missing out directory."
            exit 1
          fi
          find .gh-pages -mindepth 1 -maxdepth 1 ! -name ".git" -exec rm -rf {} +
          cp -a out/. .gh-pages/
          if [ -f public/CNAME ]; then
            cp public/CNAME .gh-pages/CNAME
          fi
          touch .gh-pages/.nojekyll

      - name: Commit and push
        run: |
          cd .gh-pages
          git add --all
          if git diff --cached --quiet; then
            echo "No changes to deploy."
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git commit -m "Deploy site"
          git push origin gh-pages
